package jinrl_exploit_servlet;

import java.io.IOException;
import java.util.Set;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import jinrl_exploit_IService.IBusiInfoService;
import jinrl_exploit_IService.IFunctionService;
import jinrl_exploit_Po.TbusiField;
import jinrl_exploit_Po.TbusiInfo;
import jinrl_exploit_Po.Tfunction;
import jinrl_exploit_common.fc;

import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

public class FollowContentServlet extends HttpServlet {
	private IFunctionService functionService;
	private IBusiInfoService busiInfoService;
	/**
	 * Constructor of the object.
	 */
	public FollowContentServlet() {
		super();
	}

	/**
	 * Destruction of the servlet. <br>
	 */
	public void destroy() {
		super.destroy(); // Just puts "destroy" string in log
		// Put your code here
	}

	public void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String currentUserid = "";
		String functionid = "";
		String pageSize = "";
		String pkfield = "";
		String followContent = request.getParameter("followContent");
		String fieldValue = request.getParameter("fieldValue");
		currentUserid = (String)request.getSession().getAttribute("currentUserid");
		String ss[] = followContent.split("\\|");
		functionid = ss[0];
		pageSize = ss[1];
		if(ss.length==2){
			pkfield = "fid";
		}else{
			pkfield = ss[2];
		}

		//
		Tfunction function = functionService.findById(functionid);
		String URL ="";
		if("M".equals(pageSize)){
			//-------------------------------显示自定义表单----------------
			String sign = fc.getMd5Str(currentUserid+functionid+"H7F65E49JED5OIF4U4DE664C66D6EET3");
			URL ="busiInfo.do?method=showUpdatePage&busiInfoid="+function.getFbusiinfoid()+"&dataid=103&currentUserid="+currentUserid+"&functionid="+functionid+"&sign="+sign;
		}else{
			//-----------------------------显示从表----------------------
			TbusiInfo busiInfo = busiInfoService.getBusiInfoByfid(function.getFbusiinfoid());
			Set<TbusiField> set = busiInfo.getTbusiFields();
			//获得查询字段
			TbusiField field = null;
			for(TbusiField f : set){
				if(pkfield.equals(f.getFfieldname())){
					field = f;
					break;
				}
			}

			String selUrl = "";
			//判断此字段查询方式
			if(field != null){
				int sg = field.getFselectgroup();
				if(sg != 1){
					selUrl = "&rfy_" + pkfield + "=" + fieldValue;
				}else{
					selUrl = "&yy_oneTypeSel=rfy_"+pkfield+"&yy_oneTypeInp="+fieldValue;
				}
			}

			String sign = fc.getMd5Str(currentUserid+functionid+"H7F65E49JED5OIF4U4DE664C66D6EET3");
			URL = "busiInfo.do?method=getBusiInfo&tbusiInfoID="+function.getFbusiinfoid()+"&currentUserid="+ currentUserid
				+ "&functionid="+functionid+"&sign="+sign+"&dataidForUpLoad=noUploadButten_12!@&pageSize="+ pageSize + selUrl;
		}
		request.getRequestDispatcher(URL).forward(request,response);
	}

	public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

		this.doPost(request, response);
	}
	public void init() throws ServletException {
		ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
		functionService = (IFunctionService) context.getBean("functionService");
		busiInfoService = (IBusiInfoService) context.getBean("busiInfoService");
	}

}
