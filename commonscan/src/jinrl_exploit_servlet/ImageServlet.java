package jinrl_exploit_servlet;

import java.io.IOException;
import java.io.OutputStream;
import java.sql.Blob;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class ImageServlet extends HttpServlet {
	private static final String DRIVER = "com.microsoft.sqlserver.jdbc.SQLServerDriver";
	private static final String URL = "jdbc:sqlserver://6.6.6.13:1718;databaseName=card2010";
	private static final String USERNAME = "jinrl";
	private static final String PWD = "jinrlP@ssw0rd";

	/**
	 * Destruction of the servlet. <br>
	 */
	public void destroy() {
		super.destroy(); // Just puts "destroy" string in log
		// Put your code here
	}

	public void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		this.doPost(request, response);
	}

	public void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		try {
			String dataid = request.getParameter("dataid");
			Class.forName(DRIVER);
			Connection con = DriverManager.getConnection(URL, USERNAME, PWD);

			try {
				// 准备语句执行对象
				Statement stmt = con.createStatement();
				String sql = " SELECT * FROM CheckCode WHERE fid = '"+dataid+"'";
				ResultSet rs = stmt.executeQuery(sql);
				if (rs.next()) {

//					String a = rs.getString("fImage");
//					System.out.println(a);
//					System.out.println("a de chang du:"+a.length());
					Blob b = rs.getBlob("fImage");
//					System.out.println(b);
					long size = b.length();
					byte[] bs = b.getBytes(1, (int) size);
//					byte[] bs = new byte[a.length()/2];
//					System.out.println("-----------");
//					for(int i = 0,j=0;i<a.length();i+=2,j++){
//						bs[j]=(byte)Integer.parseInt(a.substring(i, i+2), 16);
//					}

					response.setContentType("image/jpeg");
					OutputStream outs = response.getOutputStream();
					outs.write(bs);
					outs.flush();
					rs.close();
				} else {
					rs.close();
				}
			} finally {
				con.close();
			}

		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * Initialization of the servlet. <br>
	 *
	 * @throws ServletException
	 *             if an error occurs
	 */
	public void init() throws ServletException {
		// Put your code here
	}

}
