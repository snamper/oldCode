package jinrl_exploit_servlet;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

import jinrl_exploit_Po.TbusiInfo;
import jinrl_exploit_ServiceImpl.BusiInfoServiceImpl;
import jinrl_exploit_common.DataConnect;

public class CardOrderState extends HttpServlet {
	BusiInfoServiceImpl bfService;
	public void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		this.doPost(request, response);
	}

	public void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		String urltype = request.getParameter("urltype");
		if("0".equals(urltype)){
			response.setContentType("text/text;charset=gb2312");
			//禁止缓存
			response.setHeader("Pragma","No-Cache");
			response.setHeader("Cache-Control","No-Cache");
			response.setDateHeader("Expires",0);
		}else{
			response.setContentType("text/html;charset=gb2312");
		}
		String dataid = request.getParameter("dataid");
		//改成传递FID，然后查询对象。否则当打开多个页面的时候对出现错误。
		String busiInfoid = request.getParameter("url12345_fid");
		TbusiInfo busiInfo = bfService.getBusiInfoByfid(busiInfoid);
		DataConnect dc = new DataConnect(busiInfo.getFconndatabase(), false);
		String sql="update "+busiInfo.getFtablename()+" set fState='4' where fID='"+dataid+"'";
		int i = dc.execute(sql);
		dc.CloseConnect();
		//System.out.println(i);
		PrintWriter out = response.getWriter();
		if(i!=-1){
			out.print("修改成功！");
		}else{
			out.print("修改失败！");
		}
//		response.sendRedirect("http://abvdd");
	}

	/**
	 * Initialization of the servlet. <br>
	 *
	 * @throws ServletException
	 *             if an error occurs
	 */
	public void init() throws ServletException {
		ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
		bfService = (BusiInfoServiceImpl) context.getBean("busiInfoService");
	}

}
