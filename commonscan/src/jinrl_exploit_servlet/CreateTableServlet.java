package jinrl_exploit_servlet;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.Set;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import jinrl_exploit_IService.IBusiInfoService;
import jinrl_exploit_Po.TbusiField;
import jinrl_exploit_Po.TbusiInfo;
import jinrl_exploit_common.DataConnect;
import jinrl_exploit_common.fc;

import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

public class CreateTableServlet extends HttpServlet {

	private IBusiInfoService busiInfoService;

	public void destroy() {
		super.destroy(); // Just puts "destroy" string in log
		// Put your code here
	}

	public void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		this.doPost(request, response);
	}

	public void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		request.setCharacterEncoding("GB2312");
		response.setContentType("text/html;charset=GB2312");
		PrintWriter out = response.getWriter();
		String busiinfoID = request.getParameter("dataid");
		TbusiInfo busiInfo = busiInfoService.getBusiInfoByfid(busiinfoID);
		Set<TbusiField> set = busiInfo.getTbusiFields();
		DataConnect dc = new DataConnect(busiInfo.getFconndatabase(), false);
		try{dc.execute("select * from table1 where 1=2", false);}catch(Exception e){}
		String connUrl = dc.getConnUrl();
		String database = connUrl.substring(connUrl.indexOf("=")+1);
		StringBuffer sql = new StringBuffer();
		StringBuffer indexsql = new StringBuffer();
		//
		sql.append("USE ["+ database +"]  SET ANSI_NULLS ON  SET QUOTED_IDENTIFIER ON  SET ANSI_PADDING ON ");
		sql.append("CREATE TABLE ["+ busiInfo.getFtablename() +"](");
		for(TbusiField field : set){
			String fildtype  = field.getFfieldtype();
			if(null == fildtype || "".equals(fildtype)|| "varchar".equals(fildtype.toLowerCase())){
				fildtype = "varchar(32)";
			}else if("decimal".equals(fildtype.toLowerCase())){
				fildtype = "decimal(9.3)";
			}
			if("fid".equals(field.getFfieldname().toLowerCase())){
				sql.append("["+ field.getFfieldname() +"] "+ fildtype +" NOT NULL,");
			}else{
				sql.append("["+ field.getFfieldname() +"] "+ fildtype +" NULL,");
				if("true".equals(field.getFisselectitem())){
					indexsql.append("CREATE NONCLUSTERED INDEX "+field.getFfieldname()+"_index ON "+ busiInfo.getFtablename() +"("+field.getFfieldname()+");");
				}
			}
		}
		sql.append("CONSTRAINT [PK_"+ busiInfo.getFtablename() + fc.GetOrderID("") +"] PRIMARY KEY CLUSTERED ");
		sql.append("([fid] ASC");
		sql.append(")WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]) ON [PRIMARY] ");
		sql.append(" SET ANSI_PADDING OFF;");
		sql.append(indexsql);
		String messages = "";
		int va = 0;
		try{
			va = dc.execute(sql.toString(), false);
			//System.out.println(va);
			messages = "alert('数据库:"+ database +"表:"+ busiInfo.getFtablename() +"成功!');";
		}catch(Exception e){
			messages = "alert('失败!');";
		}finally{
			if(va == -1){
				messages = "alert('失败!');";
			}
			dc.CloseConnect();
			out.print(messages);
		}

	}

	/**
	 * Initialization of the servlet. <br>
	 *
	 * @throws ServletException if an error occurs
	 */
	public void init() throws ServletException {
		ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");
		busiInfoService = (IBusiInfoService) context.getBean("busiInfoService");
	}

}
