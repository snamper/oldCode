package jinrl_exploit_servlet.notice;

import java.sql.ResultSet;
import java.util.TimerTask;

import jinrl_exploit_common.DataConnect;
import jinrl_exploit_common.fc;

public class NoticeTimerTask extends TimerTask {

	private static DataConnect dc = new DataConnect("sysdb",true);
	
	@Override
	public void run() {
		try {
			String sql = "select TOP 1 * from tNoticeMessage where fState='1' order by fCreateTime";
			ResultSet rs = dc.query(sql);
			
			if(rs == null){
				System.out.println("ERROR,查询公告失败!");
				return;
			}
			
			if(!rs.next()){
//				System.out.println("无公告信息发送!");
				return;
			}
			
			String fid = fc.getrv(rs, "fID", "");
			
			//设置加密
			String sign = fc.getMd5Str(fid + "df89dfd89c78asas123fg344");
			
			//将fid发送到servlet
			String result = fc.SendDataViaPost("http://127.0.0.1:80/commonscan/SetNoticeServlet", "fid=" + fid + "&sign=" + sign, "GB2312");
			
			//成功，修改此条通知状态为已读，ftype='0'
			if("true".equals(result)){
				
				String updateSql = "update tNoticeMessage set fState='0' where fID='" + fid + "'";
				int n = dc.execute(updateSql);
				
				if(n > 0){
					fc.message("公告修改已读状态成功!" + fc.getTime(""));
				}else{
					System.out.println("ERROR,公告修改已读状态失败!将会在定时时间后，再次执行修改...");
				}
				
			}else{
				System.out.println("ERROR,发送URL请求失败!");
			}
			
			
			
		} catch (Exception e) {
			e.printStackTrace();
			System.out.println("ERROR,执行公告功能失败!");
		}
	}

}
